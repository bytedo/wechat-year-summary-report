<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>{{ group_name }} - ç¾¤èŠåˆ†ææŠ¥å‘Š</title>

    <!-- TailwindCSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- ECharts -->
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/echarts-wordcloud@2.1.0/dist/echarts-wordcloud.min.js"></script>

    <!-- Marked.js - Markdown æ¸²æŸ“ -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

    <style>
      /* è‡ªå®šä¹‰æ¸å˜èƒŒæ™¯ */
      .gradient-bg {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      }

      .card-gradient {
        background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
      }

      /* æ¯›ç»ç’ƒæ•ˆæœ */
      .glass {
        background: rgba(255, 255, 255, 0.9);
        backdrop-filter: blur(10px);
      }

      /* å›¾è¡¨å®¹å™¨ */
      .chart-container {
        width: 100%;
        height: 350px;
      }

      /* Markdown æ ·å¼ */
      .markdown-body h2 {
        font-size: 1.5rem;
        font-weight: 700;
        margin: 1.5rem 0 1rem;
        padding-bottom: 0.5rem;
        border-bottom: 2px solid #e5e7eb;
      }

      .markdown-body h3 {
        font-size: 1.25rem;
        font-weight: 600;
        margin: 1.25rem 0 0.75rem;
        color: #4f46e5;
      }

      .markdown-body p {
        margin: 0.75rem 0;
        line-height: 1.8;
      }

      .markdown-body ul,
      .markdown-body ol {
        margin: 0.75rem 0;
        padding-left: 1.5rem;
      }

      .markdown-body li {
        margin: 0.5rem 0;
      }

      .markdown-body blockquote {
        border-left: 4px solid #8b5cf6;
        padding: 0.5rem 1rem;
        margin: 1rem 0;
        background: #f3f4f6;
        border-radius: 0 0.5rem 0.5rem 0;
      }

      .markdown-body hr {
        margin: 1.5rem 0;
        border: none;
        border-top: 2px dashed #e5e7eb;
      }

      .markdown-body strong {
        color: #7c3aed;
      }

      /* åŠ¨ç”»æ•ˆæœ */
      @keyframes fadeInUp {
        from {
          opacity: 0;
          transform: translateY(20px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      .animate-fade-in {
        animation: fadeInUp 0.6s ease-out forwards;
      }

      .animate-delay-1 {
        animation-delay: 0.1s;
      }
      .animate-delay-2 {
        animation-delay: 0.2s;
      }
      .animate-delay-3 {
        animation-delay: 0.3s;
      }
      .animate-delay-4 {
        animation-delay: 0.4s;
      }
    </style>
  </head>
  <body class="bg-gray-50 min-h-screen">
    <!-- å¤´éƒ¨ -->
    <header class="gradient-bg text-white py-12 px-4">
      <div class="max-w-6xl mx-auto text-center">
        <h1 class="text-4xl font-bold mb-4">ğŸ“Š {{ group_name }}</h1>
        <p class="text-xl opacity-90">ç¾¤èŠå¹´åº¦åˆ†ææŠ¥å‘Š</p>
        <p class="mt-4 opacity-75">
          <span class="mr-4">ğŸ“… {{ overview.time_range }}</span>
          <span>â° ç”Ÿæˆäº {{ generated_at }}</span>
        </p>
      </div>
    </header>

    <!-- ä¸»å†…å®¹åŒº -->
    <main class="max-w-6xl mx-auto px-4 py-8">
      <!-- æ¦‚è§ˆå¡ç‰‡ -->
      <section class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-8">
        <div
          class="bg-white rounded-xl shadow-lg p-6 text-center animate-fade-in animate-delay-1 hover:shadow-xl transition-shadow"
        >
          <div class="text-4xl font-bold text-purple-600">
            {{ overview.total_messages }}
          </div>
          <div class="text-gray-500 mt-2">ğŸ’¬ æ¶ˆæ¯æ€»æ•°</div>
        </div>
        <div
          class="bg-white rounded-xl shadow-lg p-6 text-center animate-fade-in animate-delay-2 hover:shadow-xl transition-shadow"
        >
          <div class="text-4xl font-bold text-blue-600">
            {{ overview.total_users }}
          </div>
          <div class="text-gray-500 mt-2">ğŸ‘¥ å‚ä¸äººæ•°</div>
        </div>
        <div
          class="bg-white rounded-xl shadow-lg p-6 text-center animate-fade-in animate-delay-3 hover:shadow-xl transition-shadow"
        >
          <div class="text-4xl font-bold text-green-600">
            {{ overview.total_days }}
          </div>
          <div class="text-gray-500 mt-2">ğŸ“† æ´»è·ƒå¤©æ•°</div>
        </div>
        <div
          class="bg-white rounded-xl shadow-lg p-6 text-center animate-fade-in animate-delay-4 hover:shadow-xl transition-shadow"
        >
          <div class="text-4xl font-bold text-orange-600">
            {{ overview.avg_messages_per_day }}
          </div>
          <div class="text-gray-500 mt-2">ğŸ“ˆ æ—¥å‡æ¶ˆæ¯</div>
        </div>
      </section>

      <!-- äº®ç‚¹æŒ‡æ ‡ -->
      <section class="bg-white rounded-xl shadow-lg p-6 mb-8 animate-fade-in">
        <h2 class="text-xl font-bold text-gray-800 mb-4">ğŸ† ç¾¤èŠäº®ç‚¹</h2>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
          <div class="flex items-center space-x-4">
            <div
              class="w-12 h-12 bg-yellow-100 rounded-full flex items-center justify-center text-2xl"
            >
              ğŸ—£ï¸
            </div>
            <div>
              <div class="text-sm text-gray-500">è¯ç—¨æ‹…å½“</div>
              <div class="font-bold text-lg">{{ overview.top_user }}</div>
              <div class="text-sm text-gray-400">
                {{ overview.top_user_count }} æ¡æ¶ˆæ¯
              </div>
            </div>
          </div>
          <div class="flex items-center space-x-4">
            <div
              class="w-12 h-12 bg-blue-100 rounded-full flex items-center justify-center text-2xl"
            >
              ğŸŒ™
            </div>
            <div>
              <div class="text-sm text-gray-500">æœ€æ´»è·ƒæ—¶æ®µ</div>
              <div class="font-bold text-lg">
                {{ overview.most_active_hour }}
              </div>
              <div class="text-sm text-gray-400">ç¾¤å‹éƒ½æ˜¯å¤œçŒ«å­ï¼Ÿ</div>
            </div>
          </div>
          <div class="flex items-center space-x-4">
            <div
              class="w-12 h-12 bg-green-100 rounded-full flex items-center justify-center text-2xl"
            >
              ğŸ“Š
            </div>
            <div>
              <div class="text-sm text-gray-500">åˆ†ææ—¶æ®µ</div>
              <div class="font-bold text-lg">{{ overview.total_days }} å¤©</div>
              <div class="text-sm text-gray-400">{{ overview.time_range }}</div>
            </div>
          </div>
        </div>
      </section>

      <!-- AI åˆ†æåŒºåŸŸ -->
      <section class="bg-white rounded-xl shadow-lg p-6 mb-8 animate-fade-in">
        <div class="flex items-center justify-between mb-4">
          <h2 class="text-xl font-bold text-gray-800">ğŸ¤– AI æ·±åº¦åˆ†æ</h2>
          {% if is_mock %}
          <span
            class="px-3 py-1 bg-yellow-100 text-yellow-800 text-sm rounded-full"
            >æ¨¡æ‹Ÿæ•°æ®</span
          >
          {% endif %}
        </div>
        <div id="ai-content" class="markdown-body text-gray-700">
          <!-- Markdown å†…å®¹å°†ç”± JS æ¸²æŸ“ -->
        </div>
      </section>

      <!-- è¯­ä¹‰è¯é¢˜æ˜Ÿç³»å›¾ -->
      {% if has_vector_data %}
      <section class="bg-white rounded-xl shadow-lg p-6 mb-8 animate-fade-in">
        <div class="flex items-center justify-between mb-4">
          <h2 class="text-xl font-bold text-gray-800">ğŸŒŒ è¯­ä¹‰è¯é¢˜æ˜Ÿç³»å›¾</h2>
          <span class="px-3 py-1 bg-purple-100 text-purple-800 text-sm rounded-full">
            å‘é‡èšç±»åˆ†æ
          </span>
        </div>
        <p class="text-gray-500 text-sm mb-4">
          åŸºäºè¯­ä¹‰å‘é‡çš„è¯é¢˜èšç±»å¯è§†åŒ–ã€‚æ¯ä¸ªç‚¹ä»£è¡¨ä¸€æ¡æ¶ˆæ¯ï¼Œé¢œè‰²ç›¸åŒçš„ç‚¹å±äºåŒä¸€è¯é¢˜ã€‚æ‚¬åœå¯æŸ¥çœ‹è¯¦æƒ…ï¼Œæ»šè½®å¯ç¼©æ”¾ã€‚
        </p>
        <div id="chart-galaxy" style="width: 100%; height: 500px;"></div>
      </section>
      {% endif %}

      <!-- æ—¶å…‰Â·å›å¿†ç‰ˆå— -->
      {% if has_memories_data and memories_data %}
      <section class="bg-gradient-to-br from-amber-50 to-orange-50 rounded-xl shadow-lg p-6 mb-8 animate-fade-in">
        <div class="flex items-center justify-between mb-6">
          <h2 class="text-xl font-bold text-gray-800">â³ æ—¶å…‰Â·å›å¿†</h2>
          <span class="px-3 py-1 bg-amber-100 text-amber-800 text-sm rounded-full">
            æ€€æ—§æ¡£æ¡ˆ
          </span>
        </div>

        <!-- é‡‘å¥å¡ç‰‡ -->
        {% if memories_data.golden_quotes %}
        <div class="mb-8">
          <h3 class="text-lg font-semibold text-gray-700 mb-4">ğŸ’¬ å¹´åº¦é‡‘å¥</h3>
          <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
            {% for quote in memories_data.golden_quotes %}
            <div class="bg-white rounded-lg p-4 shadow-sm border-l-4 border-amber-400 hover:shadow-md transition-shadow">
              <p class="text-gray-800 font-medium mb-2">"{{ quote.content }}"</p>
              <div class="flex justify-between items-center text-sm">
                <span class="text-amber-600 font-medium">â€”â€” {{ quote.user }}</span>
                <span class="text-gray-400">{{ quote.reason }}</span>
              </div>
            </div>
            {% endfor %}
          </div>
        </div>
        {% endif %}

        <!-- é‚£å¹´ä»Šæ—¥å¡ç‰‡ -->
        {% if memories_data.peak_day and memories_data.peak_day.date %}
        <div class="mb-8">
          <h3 class="text-lg font-semibold text-gray-700 mb-4">ğŸ† å·…å³°æ—¶åˆ»</h3>
          <div class="bg-white rounded-lg p-6 shadow-sm">
            <div class="flex items-center gap-4 mb-4">
              <div class="text-4xl">ğŸ“…</div>
              <div>
                <div class="text-2xl font-bold text-amber-600">{{ memories_data.peak_day.date }}</div>
                <div class="text-gray-500">å…± {{ memories_data.peak_day.count }} æ¡æ¶ˆæ¯</div>
              </div>
            </div>
            {% if memories_data.peak_day_summary %}
            <p class="text-gray-700 italic border-l-2 border-amber-300 pl-4">
              {{ memories_data.peak_day_summary }}
            </p>
            {% endif %}
          </div>
        </div>
        {% endif %}

        <!-- æ‰“ç ´æ²‰é»˜ -->
        {% if memories_data.silence_breaker %}
        <div class="mb-8">
          <h3 class="text-lg font-semibold text-gray-700 mb-4">ğŸ”” æ‰“ç ´æ²‰é»˜çš„è‹±é›„</h3>
          <div class="bg-white rounded-lg p-4 shadow-sm flex items-center gap-4">
            <div class="text-3xl">ğŸ¦¸</div>
            <div>
              <p class="font-medium text-gray-800">{{ memories_data.silence_breaker.user }}</p>
              <p class="text-sm text-gray-500">åœ¨ç¾¤é‡Œæ²‰é»˜ {{ memories_data.silence_breaker.silence_hours }} å°æ—¶åï¼Œå‹‡æ•¢æ‰“ç ´äº†æ²‰é»˜ï¼š</p>
              <p class="text-gray-600 mt-1">"{{ memories_data.silence_breaker.content }}"</p>
            </div>
          </div>
        </div>
        {% endif %}
      </section>
      {% endif %}

      <!-- å›¾è¡¨åŒºåŸŸ -->
      <section class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
        <!-- æ¯æ—¥è¶‹åŠ¿å›¾ -->
        <div class="bg-white rounded-xl shadow-lg p-6 animate-fade-in">
          <h3 class="text-lg font-bold text-gray-800 mb-4">ğŸ“ˆ æ¯æ—¥å‘è¨€è¶‹åŠ¿</h3>
          <div id="chart-daily" class="chart-container"></div>
        </div>

        <!-- 24å°æ—¶åˆ†å¸ƒå›¾ -->
        <div class="bg-white rounded-xl shadow-lg p-6 animate-fade-in">
          <h3 class="text-lg font-bold text-gray-800 mb-4">
            ğŸ• 24å°æ—¶æ´»è·ƒåˆ†å¸ƒ
          </h3>
          <div id="chart-hourly" class="chart-container"></div>
        </div>

        <!-- è¯ç—¨æ’è¡Œæ¦œ -->
        <div class="bg-white rounded-xl shadow-lg p-6 animate-fade-in">
          <h3 class="text-lg font-bold text-gray-800 mb-4">ğŸ… è¯ç—¨æ’è¡Œæ¦œ</h3>
          <div id="chart-users" class="chart-container"></div>
        </div>

        <!-- è¯äº‘å›¾ -->
        <div class="bg-white rounded-xl shadow-lg p-6 animate-fade-in">
          <h3 class="text-lg font-bold text-gray-800 mb-4">â˜ï¸ çƒ­é—¨è¯æ±‡</h3>
          <div id="chart-wordcloud" class="chart-container"></div>
        </div>
      </section>
    </main>

    <!-- é¡µè„š -->
    <footer class="bg-gray-800 text-gray-400 py-8 text-center">
      <p>ğŸ“Š å¾®ä¿¡ç¾¤èŠåˆ†æå·¥å…· | ç”± AI é©±åŠ¨çš„å¹´åº¦æŠ¥å‘Š</p>
      <p class="mt-2 text-sm">Generated with â¤ï¸ using Python + ECharts</p>
    </footer>

    <!-- å›¾è¡¨æ¸²æŸ“è„šæœ¬ -->
    <script>
      // å›¾è¡¨æ•°æ®
      const topUsersData = {{ charts_data.top_users | safe }};
      const dailyTrendData = {{ charts_data.daily_trend | safe }};
      const hourlyData = {{ charts_data.hourly_distribution | safe }};
      const wordCloudData = {{ charts_data.word_cloud | safe }};

      // AI åˆ†æå†…å®¹
      const aiContent = `{{ ai_analysis | replace('\n', '\\n') | replace("'", "\\'") | safe }}`;

      // æ¸²æŸ“ Markdown
      document.getElementById('ai-content').innerHTML = marked.parse(aiContent);

      // æ¯æ—¥è¶‹åŠ¿å›¾
      const dailyChart = echarts.init(document.getElementById('chart-daily'));
      dailyChart.setOption({
          tooltip: { trigger: 'axis' },
          grid: { left: '3%', right: '4%', bottom: '3%', containLabel: true },
          xAxis: {
              type: 'category',
              data: dailyTrendData.map(d => d.date),
              axisLabel: { rotate: 45, fontSize: 10 }
          },
          yAxis: { type: 'value', name: 'æ¶ˆæ¯æ•°' },
          series: [{
              name: 'æ¶ˆæ¯æ•°',
              type: 'line',
              smooth: true,
              areaStyle: {
                  color: new echarts.graphic.LinearGradient(0, 0, 0, 1, [
                      { offset: 0, color: 'rgba(102, 126, 234, 0.5)' },
                      { offset: 1, color: 'rgba(102, 126, 234, 0.05)' }
                  ])
              },
              lineStyle: { color: '#667eea', width: 2 },
              itemStyle: { color: '#667eea' },
              data: dailyTrendData.map(d => d.count)
          }]
      });

      // 24å°æ—¶åˆ†å¸ƒå›¾
      const hourlyChart = echarts.init(document.getElementById('chart-hourly'));
      hourlyChart.setOption({
          tooltip: { trigger: 'axis' },
          grid: { left: '3%', right: '4%', bottom: '3%', containLabel: true },
          xAxis: {
              type: 'category',
              data: hourlyData.map(d => d.hour + ':00'),
              axisLabel: { rotate: 45, fontSize: 10 }
          },
          yAxis: { type: 'value', name: 'æ¶ˆæ¯æ•°' },
          series: [{
              name: 'æ¶ˆæ¯æ•°',
              type: 'bar',
              itemStyle: {
                  color: new echarts.graphic.LinearGradient(0, 0, 0, 1, [
                      { offset: 0, color: '#764ba2' },
                      { offset: 1, color: '#667eea' }
                  ])
              },
              data: hourlyData.map(d => d.count)
          }]
      });

      // è¯ç—¨æ’è¡Œæ¦œï¼ˆæ¨ªå‘æŸ±çŠ¶å›¾ï¼‰
      const usersChart = echarts.init(document.getElementById('chart-users'));
      const usersReversed = [...topUsersData].reverse();
      usersChart.setOption({
          tooltip: { trigger: 'axis', axisPointer: { type: 'shadow' } },
          grid: { left: '3%', right: '10%', bottom: '3%', containLabel: true },
          xAxis: { type: 'value', name: 'æ¶ˆæ¯æ•°' },
          yAxis: {
              type: 'category',
              data: usersReversed.map(d => d.user),
              axisLabel: { fontSize: 12 }
          },
          series: [{
              name: 'æ¶ˆæ¯æ•°',
              type: 'bar',
              itemStyle: {
                  color: new echarts.graphic.LinearGradient(0, 0, 1, 0, [
                      { offset: 0, color: '#667eea' },
                      { offset: 1, color: '#764ba2' }
                  ])
              },
              label: {
                  show: true,
                  position: 'right',
                  formatter: '{c}'
              },
              data: usersReversed.map(d => d.count)
          }]
      });

      // è¯äº‘å›¾
      const wordCloudChart = echarts.init(document.getElementById('chart-wordcloud'));
      wordCloudChart.setOption({
          series: [{
              type: 'wordCloud',
              shape: 'circle',
              gridSize: 8,
              sizeRange: [14, 60],
              rotationRange: [-45, 45],
              textStyle: {
                  fontFamily: 'sans-serif',
                  fontWeight: 'bold',
                  color: function() {
                      const colors = ['#667eea', '#764ba2', '#f093fb', '#f5576c', '#4facfe', '#43e97b'];
                      return colors[Math.floor(Math.random() * colors.length)];
                  }
              },
              emphasis: {
                  textStyle: { shadowBlur: 10, shadowColor: '#333' }
              },
              data: wordCloudData.map(d => ({ name: d.word, value: d.count }))
          }]
      });

      // è¯é¢˜æ˜Ÿç³»å›¾ï¼ˆå‘é‡èšç±»å¯è§†åŒ–ï¼‰
      {% if has_vector_data %}
      const scatterData = {{ vector_data.scatter_data | safe }};
      const clusterStats = {{ vector_data.cluster_stats | safe }};
      
      // èšç±»é¢œè‰²é…ç½®
      const clusterColors = [
          '#667eea', '#764ba2', '#f093fb', '#f5576c', 
          '#4facfe', '#43e97b', '#fa709a', '#fee140'
      ];
      
      // æŒ‰èšç±»åˆ†ç»„æ•°æ®
      const seriesData = {};
      scatterData.forEach(point => {
          const clusterId = point.cluster_id;
          if (!seriesData[clusterId]) {
              seriesData[clusterId] = [];
          }
          seriesData[clusterId].push([point.x, point.y, point.content, point.user]);
      });
      
      // æ„å»º series
      const galaxySeries = Object.keys(seriesData).map(clusterId => {
          const stat = clusterStats.find(s => s.cluster_id === parseInt(clusterId)) || {};
          return {
              name: stat.name || `è¯é¢˜ ${parseInt(clusterId) + 1}`,
              type: 'scatter',
              data: seriesData[clusterId],
              symbolSize: 8,
              itemStyle: {
                  color: clusterColors[clusterId % clusterColors.length],
                  opacity: 0.8
              },
              emphasis: {
                  itemStyle: {
                      opacity: 1,
                      shadowBlur: 10,
                      shadowColor: 'rgba(0, 0, 0, 0.3)'
                  }
              }
          };
      });
      
      const galaxyChart = echarts.init(document.getElementById('chart-galaxy'));
      galaxyChart.setOption({
          tooltip: {
              trigger: 'item',
              formatter: function(params) {
                  const [x, y, content, user] = params.data;
                  return `<div style="max-width: 300px;">
                      <strong>${user}</strong><br/>
                      <span style="font-size: 12px; color: #666;">${content}</span>
                  </div>`;
              },
              extraCssText: 'white-space: pre-wrap;'
          },
          legend: {
              data: galaxySeries.map(s => s.name),
              top: 10,
              textStyle: { fontSize: 12 }
          },
          grid: {
              left: '3%',
              right: '3%',
              bottom: '10%',
              top: '15%',
              containLabel: true
          },
          xAxis: {
              type: 'value',
              axisLine: { show: false },
              axisTick: { show: false },
              axisLabel: { show: false },
              splitLine: { 
                  lineStyle: { color: '#f0f0f0', type: 'dashed' }
              }
          },
          yAxis: {
              type: 'value',
              axisLine: { show: false },
              axisTick: { show: false },
              axisLabel: { show: false },
              splitLine: { 
                  lineStyle: { color: '#f0f0f0', type: 'dashed' }
              }
          },
          dataZoom: [
              { type: 'inside', xAxisIndex: 0 },
              { type: 'inside', yAxisIndex: 0 }
          ],
          series: galaxySeries
      });
      {% endif %}

      // å“åº”å¼è°ƒæ•´
      window.addEventListener('resize', function() {
          dailyChart.resize();
          hourlyChart.resize();
          usersChart.resize();
          wordCloudChart.resize();
          {% if has_vector_data %}
          galaxyChart.resize();
          {% endif %}
      });
    </script>
  </body>
</html>
