<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"
    />
    <title>{{ group_name }} - å¹´åº¦å›å¿†</title>

    <!-- TailwindCSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- ECharts -->
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
  </head>
  <body>
    <!-- Data Injection for Charts -->
    <script id="chart-data-hourly" type="application/json">
      {{ charts.hourly | tojson if charts.hourly else '[]' }}
    </script>
    <script id="chart-data-monthly" type="application/json">
      {{ charts.monthly | tojson if charts.monthly else '[]' }}
    </script>

    <!-- ... (rest of body) ... -->
    
    <!-- ... (rest of body) ... -->
    
    <!-- Scripts at bottom -->

    <!-- Google Fonts -->

    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@300;400;500;700;900&display=swap"
      rel="stylesheet"
    />

    <style>
      :root {
        --wc-green: #07c160;
        --wc-bg: #ededed;
        --wc-card-bg: #ffffff;
        --wc-text-primary: #191919;
        --wc-text-secondary: #b2b2b2;
        --wc-text-desc: #576b95; /* Link color/Desc color often used in WeChat */
      }

      * {
        font-family: "Noto Sans SC", -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
        -webkit-tap-highlight-color: transparent;
      }

      html,
      body {
        margin: 0;
        padding: 0;
        overflow: hidden;
        background-color: var(--wc-bg);
        color: var(--wc-text-primary);
      }

      .swiper {
        width: 100%;
        height: 100vh;
      }

      .swiper-wrapper {
        display: flex !important;
        flex-direction: row !important;
      }

      .swiper-slide {
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        padding: 24px;
        box-sizing: border-box;
        overflow: hidden;
        position: relative;
        background-color: var(--wc-bg); /* Global Background */
        width: 100% !important;
        height: 100vh !important;
        flex-shrink: 0;
      }

      /* WeChat Style Card */
      .wechat-card {
        background: var(--wc-card-bg);
        border-radius: 8px; /* Classic WeChat rounded corners */
        padding: 24px;
        width: 100%;
        box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
        margin-bottom: 16px;
        position: relative;
      }

      /* Typography Utilities */
      .text-wc-primary {
        color: var(--wc-text-primary);
      }
      .text-wc-secondary {
        color: #888888;
      }
      .text-wc-green {
        color: var(--wc-green);
      }
      .text-wc-desc {
        color: var(--wc-text-desc);
      }

      /* Animations */
      @keyframes fadeInUp {
        from {
          opacity: 0;
          transform: translateY(20px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      @keyframes scaleIn {
        from {
          opacity: 0;
          transform: scale(0.9);
        }
        to {
          opacity: 1;
          transform: scale(1);
        }
      }

      .animate-enter {
        animation: fadeInUp 0.8s cubic-bezier(0.2, 0.8, 0.2, 1) forwards;
        opacity: 0;
      }
      
      .animate-scale {
        animation: scaleIn 0.6s cubic-bezier(0.2, 0.8, 0.2, 1) forwards;
        opacity: 0;
      }

      .delay-100 { animation-delay: 0.1s; }
      .delay-200 { animation-delay: 0.2s; }
      .delay-300 { animation-delay: 0.3s; }
      .delay-400 { animation-delay: 0.4s; }
      .delay-500 { animation-delay: 0.5s; }

      /* Audio Control */
      .audio-control {
        position: fixed;
        top: 20px;
        right: 20px;
        z-index: 100;
        width: 36px;
        height: 36px;
        border-radius: 50%;
        background: rgba(0, 0, 0, 0.1);
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: all 0.3s ease;
        border: 1px solid rgba(255,255,255,0.5);
      }
      
      .audio-control.playing {
        background: var(--wc-green);
        animation: spin 4s linear infinite;
        border: none;
      }

      @keyframes spin {
        from { transform: rotate(0deg); }
        to { transform: rotate(360deg); }
      }

      /* Specific Components */
      .avatar-circle {
        width: 40px;
        height: 40px;
        border-radius: 4px; /* WeChat avatars are slightly rounded squares usually, but circles are fine for design */
        background: #e0e0e0;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
        color: #fff;
        font-size: 16px;
      }

      .progress-bar-bg {
        background-color: #f0f0f0;
        border-radius: 10px;
        height: 6px;
        overflow: hidden;
      }
      
      .progress-bar-fill {
        background-color: var(--wc-green);
        height: 100%;
        border-radius: 10px;
      }
      
      .chat-bubble {
        background: #95ec69; /* WeChat sender bubble green */
        color: #000;
        padding: 10px 14px;
        border-radius: 6px;
        position: relative;
        display: inline-block;
      }
      
      .chat-bubble-white {
        background: #ffffff;
        color: #000;
        padding: 10px 14px;
        border-radius: 6px;
        display: inline-block;
        border: 1px solid #f0f0f0;
      }

      /* Swiper Pagination */
      .swiper-pagination {
        bottom: 20px !important;
        left: 50% !important;
        transform: translateX(-50%);
        width: auto !important;
      }
      .swiper-pagination-bullet {
        background: #ccc;
        opacity: 1;
        width: 8px;
        height: 8px;
        margin: 0 4px !important;
      }
      .swiper-pagination-bullet-active {
        background: var(--wc-green);
        width: 20px;
        border-radius: 4px;
      }
      
      /* Slide Bottom Hint */
      .swipe-hint {
        position: absolute;
        bottom: 24px;
        left: 50%;
        transform: translateX(-50%);
        color: var(--wc-text-secondary);
        font-size: 12px;
        animation: bounce 2s infinite;
        opacity: 0.6;
      }
      
       @keyframes bounce {
        0%, 20%, 50%, 80%, 100% {transform: translateX(-50%) translateY(0);}
        40% {transform: translateX(-50%) translateY(-6px);}
        60% {transform: translateX(-50%) translateY(-3px);}
      }

      /* Layout helpers */
      .stats-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 12px;
      }

      /* Decorative */
      .wechat-icon {
        width: 64px;
        height: 64px;
        background: var(--wc-green);
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        margin: 0 auto 24px;
        box-shadow: 0 4px 12px rgba(7, 193, 96, 0.3);
      }
    </style>
  </head>
  <body>
    <!-- Background Music -->
    <audio id="bgMusic" loop preload="auto">
      <source
        src="{{ music_url | default('https://music.163.com/song/media/outer/url?id=1901371647.mp3') }}"
        type="audio/mpeg"
      />
    </audio>

    <div class="audio-control" id="audioControl" onclick="toggleMusic()">
      <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19V6l12-3v13M9 19c0 1.105-1.343 2-3 2s-3-.895-3-2 1.343-2 3-2 3 .895 3 2zm12-3c0 1.105-1.343 2-3 2s-3-.895-3-2 1.343-2 3-2 3 .895 3 2z" />
      </svg>
    </div>

    <div class="swiper">
      <div class="swiper-wrapper">
        
        <!-- COVER PAGE -->
        <div class="swiper-slide">
          <div class="text-center w-full max-w-md">
            <div class="wechat-icon animate-scale">
               <svg xmlns="http://www.w3.org/2000/svg" class="h-10 w-10 text-white" viewBox="0 0 20 20" fill="currentColor">
                  <path d="M2 5a2 2 0 012-2h12a2 2 0 012 2v10a2 2 0 01-2 2H4a2 2 0 01-2-2V5zm3.172 6.17a1.001 1.001 0 10-1.414 1.414l2.828 2.829a1 1 0 001.414 0l8.486-8.485a1 1 0 10-1.414-1.414l-7.779 7.778-2.12-2.12z" />
              </svg>
            </div>
            
            <h1 class="text-3xl font-bold text-wc-primary mb-2 animate-enter delay-100">
              {{ group_name }}
            </h1>
            <p class="text-xl text-wc-secondary mb-8 animate-enter delay-200">
              {{ year }} å¹´åº¦æ•°æ®æŠ¥å‘Š
            </p>
            
            <div class="wechat-card animate-enter delay-300">
              <div class="flex items-center justify-between border-b border-gray-100 pb-4 mb-4">
                 <span class="text-gray-500 text-sm">ç»Ÿè®¡æ—¶é—´</span>
                 <span class="text-wc-primary font-medium text-sm">{{ date_range.split(' ')[0] }} èµ·</span>
              </div>
               <div class="flex items-center justify-between">
                 <span class="text-gray-500 text-sm">ç”Ÿæˆæ—¶é—´</span>
                 <span class="text-wc-primary font-medium text-sm">{{ date_range.split(' ')[-1] if ' ' in date_range else date_range }}</span>
              </div>
            </div>
            
             <p class="text-gray-400 text-xs mt-12 animate-enter delay-400">
              å·¦æ»‘å¼€å¯å›å¿† &larr;
            </p>
          </div>
        </div>

        <!-- STATS OVERVIEW -->
        <div class="swiper-slide">
          <div class="w-full max-w-md">
            <h2 class="text-2xl font-bold text-wc-primary mb-6 animate-enter">è¿™ä¸€å¹´</h2>
            
            <div class="wechat-card animate-enter delay-100 p-8 text-center">
              <div class="text-sm text-gray-500 mb-2">å…±äº§ç”Ÿäº†</div>
              <div class="text-5xl font-bold text-wc-green" data-count="{{ overview.total_messages }}">0</div>
              <div class="text-sm text-gray-500 mt-2">æ¡æ¶ˆæ¯</div>
            </div>
            
            <div class="stats-grid animate-enter delay-200">
              <div class="wechat-card text-center">
                <div class="text-2xl font-bold text-wc-primary mb-1" data-count="{{ overview.total_users }}">0</div>
                <div class="text-xs text-gray-500">ä½ç¾¤å‹å‚ä¸</div>
              </div>
              <div class="wechat-card text-center">
                <div class="text-2xl font-bold text-wc-primary mb-1" data-count="{{ overview.total_days }}">0</div>
                <div class="text-xs text-gray-500">å¤©çƒ­é—¹éå‡¡</div>
              </div>
            </div>
            
            <div class="wechat-card animate-enter delay-300 flex items-center justify-between">
                <span class="text-gray-600">æ—¥å‡æ¶ˆæ¯</span>
                 <span class="text-xl font-bold text-wc-green">{{ overview.avg_per_day }} æ¡</span>
            </div>
          </div>
        </div>

        <!-- TOP TALKERS (RANKING) -->
        <div class="swiper-slide">
           <div class="w-full max-w-md h-full flex flex-col justify-center">
             <h2 class="text-2xl font-bold text-wc-primary mb-6 animate-enter">æ´»è·ƒæ¦œå•</h2>
             
             <div class="wechat-card animate-enter delay-100 p-0 overflow-hidden">
               <!-- Header -->
               <div class="bg-gray-50 px-5 py-3 border-b border-gray-100 flex justify-between text-xs text-gray-500">
                 <span>æ’å / ç”¨æˆ·</span>
                 <span>å‘è¨€æ•°</span>
               </div>
               
               <div class="divide-y divide-gray-100">
                  {% for user in rankings.top_talkers[:6] %}
                  <div class="flex items-center px-5 py-4">
                    <div class="w-6 text-center text-sm font-bold text-gray-400 mr-4">
                      {% if loop.index <= 3 %}
                        <span class="text-yellow-500 text-lg">
                           {% if loop.index == 1 %}ğŸ¥‡{% elif loop.index == 2 %}ğŸ¥ˆ{% else %}ğŸ¥‰{% endif %}
                        </span>
                      {% else %}
                        {{ loop.index }}
                      {% endif %}
                    </div>
                    
                    <div class="flex-1">
                      <div class="text-wc-primary font-medium text-sm truncate w-32">{{ user.user }}</div>
                      <div class="w-full bg-gray-100 rounded-full h-1.5 mt-2 overflow-hidden">
                        <div class="bg-green-500 h-1.5 rounded-full" data-width="{{ user.percentage * 2 }}%" style="width: 0%"></div>
                      </div>
                    </div>
                    
                    <div class="text-right pl-4">
                       <div class="text-wc-green font-bold text-sm">{{ user.count }}</div>
                       <div class="text-gray-300 text-xs">{{ user.percentage }}%</div>
                    </div>
                  </div>
                  {% endfor %}
               </div>
             </div>
           </div>
        </div>

        <!-- MONTHLY DATA (LOOP) -->
        {% for month in monthly_data %}
        <div class="swiper-slide">
           <div class="w-full max-w-md relative">
             <div class="absolute -top-16 right-0 text-6xl font-black text-gray-100 z-0 pointer-events-none select-none">
               {{ month.month_num }}
             </div>
             
             <h2 class="text-2xl font-bold text-wc-primary mb-1 animate-enter relative z-10">{{ month.month_name }}</h2>
             <p class="text-sm text-gray-400 mb-6 animate-enter delay-100 relative z-10">è¿™ä¸€æœˆçš„ç‹¬å®¶è®°å¿†</p>
             
             <!-- Stats Row -->
             <div class="grid grid-cols-3 gap-3 mb-4 animate-enter delay-200 relative z-10">
               <div class="bg-white rounded-lg p-3 text-center shadow-sm">
                 <div class="text-wc-green font-bold text-lg">{{ month.stats.total_messages }}</div>
                 <div class="text-xs text-gray-400">æ¡æ¶ˆæ¯</div>
               </div>
               <div class="bg-white rounded-lg p-3 text-center shadow-sm">
                 <div class="text-gray-800 font-bold text-lg">{{ month.stats.active_users }}</div>
                 <div class="text-xs text-gray-400">äººå‚ä¸</div>
               </div>
               <div class="bg-white rounded-lg p-3 text-center shadow-sm">
                 <div class="text-gray-800 font-bold text-lg">{{ month.stats.active_days }}</div>
                 <div class="text-xs text-gray-400">å¤©æ´»è·ƒ</div>
               </div>
             </div>
             
             <!-- AI Memory -->
             {% set memory = topic_memories | selectattr('month_key', 'equalto', month.month) | first %}
             {% if memory %}
               <div class="wechat-card animate-enter delay-300 relative z-10">
                 
                 {% if memory.topics %}
                 <div class="mb-4">
                    <div class="text-xs text-gray-400 mb-2">ğŸ“Œ çƒ­èŠè¯é¢˜</div>
                    <div class="flex flex-wrap gap-2">
                       {% for topic in memory.topics[:3] %}
                       <span class="bg-gray-100 text-gray-600 px-2 py-1 rounded text-xs"># {{ topic.title }}</span>
                       {% endfor %}
                    </div>
                 </div>
                 {% endif %}
                 
                 {% if memory.memory %}
                 <div class="bg-gray-50 p-3 rounded text-sm text-gray-600 leading-relaxed border-l-4 border-green-500">
                   {{ memory.memory }}
                 </div>
                 {% endif %}
               </div>
             {% endif %}
             
             <!-- Highlights -->
             <div class="grid grid-cols-2 gap-3 animate-enter delay-400 relative z-10">
                {% if month.highlights.monthly_star %}
                <div class="bg-white p-3 rounded-lg shadow-sm flex items-center">
                   <div class="w-8 h-8 rounded bg-yellow-100 text-yellow-600 flex items-center justify-center mr-2 text-xs font-bold">â˜…</div>
                   <div class="overflow-hidden">
                      <div class="text-xs text-gray-400">æœˆåº¦ä¹‹æ˜Ÿ</div>
                      <div class="text-sm font-bold truncate">{{ month.highlights.monthly_star.user }}</div>
                   </div>
                </div>
                {% endif %}
                
                 {% if month.highlights.busiest_day %}
                <div class="bg-white p-3 rounded-lg shadow-sm flex items-center">
                   <div class="w-8 h-8 rounded bg-red-100 text-red-600 flex items-center justify-center mr-2 text-xs font-bold">ğŸ”¥</div>
                   <div class="overflow-hidden">
                      <div class="text-xs text-gray-400">æœ€çƒ­ä¸€å¤©</div>
                      <div class="text-sm font-bold truncate">{{ month.highlights.busiest_day.date[-5:] }}</div>
                   </div>
                </div>
                {% endif %}
             </div>
             
           </div>
        </div>
        {% endfor %}

        <!-- FUN FACTS -->
        <div class="swiper-slide">
           <div class="w-full max-w-md">
              <h2 class="text-2xl font-bold text-wc-primary mb-6 animate-enter">æ•°æ®è¶£é—»</h2>
              
              <div class="space-y-4">
                {% for fact in fun_facts[:4] %}
                <div class="wechat-card flex items-center p-4 animate-enter" data-delay="{{ loop.index * 0.1 }}s">
                   <div class="text-3xl mr-4 bg-gray-100 w-12 h-12 rounded-full flex items-center justify-center">{{ fact.icon }}</div>
                   <div class="flex-1">
                      <div class="text-sm text-gray-500">{{ fact.title }}</div>
                      <div class="text-lg font-bold text-wc-primary">
                        {{ fact.value }} <span class="text-sm font-normal">{{ fact.unit }}</span>
                      </div>
                      <div class="text-xs text-gray-400 mt-1">{{ fact.description }}</div>
                   </div>
                </div>
                {% endfor %}
              </div>
           </div>
        </div>

        <!-- SPECIAL AWARDS (Eagle/Night Owl) -->
        <div class="swiper-slide">
          <div class="w-full max-w-md">
             <h2 class="text-2xl font-bold text-wc-primary mb-6 animate-enter">ç‰¹åˆ«å¥–é¡¹</h2>
             
             <div class="grid gap-4">
                <!-- Early Bird -->
                {% if highlights.early_bird and highlights.early_bird.user %}
                <div class="wechat-card animate-enter delay-100 bg-gradient-to-br from-white to-orange-50">
                   <div class="flex items-center mb-3">
                      <span class="text-2xl mr-2">â˜€ï¸</span>
                      <span class="font-bold text-gray-800">æ—©èµ·é¸Ÿ</span>
                   </div>
                   <div class="flex items-baseline mb-1">
                      <span class="text-xl font-bold text-wc-green mr-2">{{ highlights.early_bird.user }}</span>
                      <span class="text-xs text-gray-500">{{ highlights.early_bird.days }}æ¬¡é¦–å‘</span>
                   </div>
                   <p class="text-xs text-gray-400">æ€»æ˜¯ç¬¬ä¸€ä¸ªå«é†’ç¾¤å‹çš„äºº</p>
                </div>
                {% endif %}
                
                <!-- Night Owl -->
                {% if highlights.night_owl and highlights.night_owl.user %}
                <div class="wechat-card animate-enter delay-200 bg-gradient-to-br from-white to-indigo-50">
                   <div class="flex items-center mb-3">
                      <span class="text-2xl mr-2">ğŸŒ™</span>
                      <span class="font-bold text-gray-800">å¤œçŒ«å­</span>
                   </div>
                   <div class="flex items-baseline mb-1">
                      <span class="text-xl font-bold text-wc-green mr-2">{{ highlights.night_owl.user }}</span>
                      <span class="text-xs text-gray-500">{{ highlights.night_owl.count }}æ¡å¤œé—´æ¶ˆæ¯</span>
                   </div>
                   <p class="text-xs text-gray-400">å®ˆæŠ¤æ·±å¤œçš„å®é™ä¸å–§åš£</p>
                </div>
                {% endif %}
             </div>
          </div>
        </div>

        <!-- KEYWORDS -->
        <div class="swiper-slide">
           <div class="w-full max-w-md text-center">
              <h2 class="text-2xl font-bold text-wc-primary mb-2 animate-enter">å¹´åº¦å…³é”®è¯</h2>
              <p class="text-gray-400 text-sm mb-8 animate-enter delay-100">æˆ‘ä»¬çš„å…±åŒè¯­è¨€</p>
              
              <div class="flex flex-wrap justify-center gap-3 animate-enter delay-200">
                 {% for word in keywords[:15] %}
                 <span 
                   class="px-4 py-2 rounded-full border border-gray-200 bg-white shadow-sm text-gray-700 animate-scale"
                   data-delay="{{ loop.index * 0.05 }}s" data-font-size="{{ 10 + (100 / (loop.index + 2)) }}px"
                 >
                    {{ word.word }}
                 </span>
                 {% endfor %}
              </div>
           </div>
        </div>

        <!-- USER PROFILES (MBTI) -->
        {% if user_profiles_mbti %}
        <div class="swiper-slide">
           <div class="w-full max-w-md h-full flex flex-col pt-12">
              <h2 class="text-2xl font-bold text-wc-primary mb-2 animate-enter px-2">ç¾¤å‹ç¾¤ç›¸</h2>
              <p class="text-sm text-gray-400 mb-4 animate-enter delay-100 px-2">çœ‹çœ‹è°æ˜¯ä»€ä¹ˆäººæ ¼ âœ¨</p>
              
              <div class="overflow-y-auto px-2 pb-12 flex-1 swiper-no-swiping" style="scrollbar-width: none;">
                 <div class="space-y-3">
                    {% for profile in user_profiles_mbti[:10] %}
                    <!-- æ¶ˆæ¯æ°”æ³¡æ ·å¼ -->
                    <div class="animate-enter flex items-start gap-2 {{ 'flex-row-reverse' if loop.index % 2 == 0 else '' }}" data-delay="{{ loop.index * 0.12 }}s">
                       <div class="max-w-[85%]">
                          <!-- ç”¨æˆ·åå’ŒMBTIæ ‡ç­¾ -->
                          <div class="flex items-center gap-2 mb-1 {{ 'flex-row-reverse' if loop.index % 2 == 0 else '' }}">
                             <span class="text-xs font-medium text-gray-600">{{ profile.user }}</span>
                             <span class="px-1.5 py-0.5 text-[10px] font-bold rounded {{ 'bg-green-100 text-green-600' if loop.index % 4 == 1 else 'bg-blue-100 text-blue-600' if loop.index % 4 == 2 else 'bg-purple-100 text-purple-600' if loop.index % 4 == 3 else 'bg-orange-100 text-orange-600' }}">{{ profile.mbti }}</span>
                          </div>
                          <!-- æ¶ˆæ¯æ°”æ³¡ -->
                          <div class="p-3 rounded-2xl shadow-sm text-sm leading-relaxed {{ 'bg-[#95ec69] rounded-tr-sm' if loop.index % 2 == 0 else 'bg-white border border-gray-100 rounded-tl-sm' }}">
                             <span class="font-medium">{{ profile.persona }}</span>
                             {% if profile.description and profile.description|length < 50 %}
                             <span class="text-gray-500 ml-1">Â· {{ profile.description }}</span>
                             {% endif %}
                          </div>
                       </div>
                    </div>
                    {% endfor %}
                 </div>
                 
                 <!-- åº•éƒ¨ç•™ç™½ -->
                 <div class="h-8"></div>
              </div>
           </div>
        </div>
        {% endif %}

        <!-- WEEKLY AI SUMMARY (YEARLY REVIEW) -->
        {% if weekly_ai_summary %}
        <div class="swiper-slide">
           <div class="w-full max-w-md h-full flex flex-col pt-12 pb-12">
              <h2 class="text-2xl font-bold text-wc-primary mb-2 animate-enter px-2">AI å¹´åº¦æ·±åº¦å›é¡¾</h2>
              <p class="text-sm text-gray-400 mb-6 animate-enter delay-100 px-2 pl-2">åŸºäº 52 å‘¨å…¨é‡æ•°æ®çš„æ·±åº¦æ´å¯Ÿ</p>
              
              <div class="overflow-y-auto px-2 flex-1 relative swiper-no-swiping" style="scrollbar-width: none;">
                 <div class="bg-white rounded-lg p-5 shadow-sm border-t-4 border-wc-green leading-relaxed text-gray-700 text-sm markdown-body animate-enter delay-200">
                    {{ weekly_ai_summary | replace('\n', '<br>') | safe }}
                 </div>
                 <div class="h-8"></div>
              </div>
           </div>
        </div>
        {% endif %}

        <!-- KEYWORDS -->
        <div class="swiper-slide">
           <div class="text-center w-full max-w-md">
              <div class="text-6xl mb-6 animate-scale text-red-500">â¤</div>
              <h2 class="text-2xl font-bold text-wc-primary mb-4 animate-enter">æ„Ÿè°¢æœ‰ä½ </h2>
              <p class="text-gray-500 mb-10 animate-enter delay-200">
                æ˜å¹´è§ Â· {{ group_name }}
              </p>
              
              <div class="wechat-card animate-enter delay-300 w-auto inline-block px-8">
                 <div class="text-wc-green font-bold text-lg mb-1">{{ year }}</div>
                 <div class="text-xs text-gray-400">å¹´åº¦å›å¿†å½•</div>
              </div>
           </div>
        </div>

      </div>
      <div class="swiper-pagination"></div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.js"></script>
    <script>
      // --- Chart Data Handling ---
      function getChartData(id) {
        try {
          const el = document.getElementById(id);
          return el ? JSON.parse(el.textContent) : [];
        } catch (e) {
          console.error("Failed to parse chart data", e);
          return [];
        }
      }

      const chartData = {
        hourly: getChartData('chart-data-hourly'),
        monthly: getChartData('chart-data-monthly')
      };
      
      let hourlyChart = null;
      let monthlyChart = null;

      function renderCharts() {
        // Render Hourly Chart
        if (document.getElementById('chart-hourly') && chartData.hourly.length > 0 && !hourlyChart) {
           hourlyChart = echarts.init(document.getElementById('chart-hourly'));
           hourlyChart.setOption({
              color: ['#07c160'],
              grid: { top: 20, right: 10, bottom: 20, left: 40 },
              tooltip: { trigger: 'axis' },
              xAxis: { type: 'category', data: Array.from({length: 24}, (_, i) => i + 'æ—¶') },
              yAxis: { type: 'value', splitLine: { lineStyle: { type: 'dashed' } } },
              series: [{
                 data: chartData.hourly,
                 type: 'line',
                 smooth: true,
                 areaStyle: { opacity: 0.2 }
              }]
           });
        }
        
        // Render Monthly Chart
        if (document.getElementById('chart-monthly') && chartData.monthly.length > 0 && !monthlyChart) {
           monthlyChart = echarts.init(document.getElementById('chart-monthly'));
           monthlyChart.setOption({
              color: ['#07c160'],
              grid: { top: 20, right: 10, bottom: 20, left: 40 },
              tooltip: { trigger: 'axis' },
              xAxis: { type: 'category', data: Array.from({length: 12}, (_, i) => (i + 1) + 'æœˆ') },
              yAxis: { type: 'value', splitLine: { lineStyle: { type: 'dashed' } } },
              series: [{
                 data: chartData.monthly,
                 type: 'bar',
                 itemStyle: { borderRadius: [4, 4, 0, 0] }
              }]
           });
        }
      }

      // --- Swiper & Animations ---
      const swiper = new Swiper(".swiper", {
        direction: "horizontal",
        slidesPerView: 1,
        spaceBetween: 0,
        mousewheel: true,
        pagination: {
          el: ".swiper-pagination",
          clickable: true,
        },
        on: {
          slideChangeTransitionStart: function () {
             animateSlide(this.activeIndex);
             // Render/Resize charts when slide changes
             setTimeout(renderCharts, 100); 
          },
          init: function () {
            setTimeout(() => {
                animateSlide(0);
                renderCharts();
            }, 100);
          },
          resize: function () {
             if(hourlyChart) hourlyChart.resize();
             if(monthlyChart) monthlyChart.resize();
          }
        },
      });

      function animateSlide(index) {
        const slide = document.querySelectorAll(".swiper-slide")[index];
        if (!slide) return;
        
        // Apply Dynamic Styles (from data attributes to avoid Jinja/IDE conflicts)
        const dynamicElements = slide.querySelectorAll('[data-width], [data-delay], [data-font-size]');
        dynamicElements.forEach(el => {
           if (el.dataset.width) el.style.width = el.dataset.width;
           if (el.dataset.delay) el.style.animationDelay = el.dataset.delay;
           if (el.dataset.fontSize) el.style.fontSize = el.dataset.fontSize;
        });
        
        // Restart Animations
        const animatedElements = slide.querySelectorAll('.animate-enter, .animate-scale');
        animatedElements.forEach((el) => {
          el.style.animation = 'none';
          el.offsetHeight; /* trigger reflow */
          el.style.animation = null; 
        });

        // Number Rolling
        const countElements = slide.querySelectorAll("[data-count]");
        countElements.forEach((el) => {
          animateNumber(el, parseInt(el.dataset.count));
        });
      }

      function animateNumber(el, target) {
         let start = 0;
         const duration = 1200;
         const step = timestamp => {
            if (!start) start = timestamp;
            const progress = Math.min((timestamp - start) / duration, 1);
            el.innerText = Math.floor(progress * target);
            if (progress < 1) {
               window.requestAnimationFrame(step);
            } else {
               el.innerText = target;
            }
         };
         window.requestAnimationFrame(step);
      }

      // --- Audio Control ---
      const bgMusic = document.getElementById("bgMusic");
      const audioControl = document.getElementById("audioControl");
      let isPlaying = false;

      function toggleMusic() {
        if (isPlaying) {
          bgMusic.pause();
          audioControl.classList.remove("playing");
        } else {
          bgMusic.play().catch(e => console.log("Audio play failed", e));
          audioControl.classList.add("playing");
        }
        isPlaying = !isPlaying;
      }
      
      // Auto Play on first interaction
      document.body.addEventListener('click', function() {
         if(!isPlaying) {
             toggleMusic();
         }
      }, { once: true });
    </script>
  </body>
</html>
